<!DOCTYPE html>
<html data-theme="light">
  <head>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="icon" href="https://elastic.co/favicon.ico" type="image/x-icon" />
    <script src="https://unpkg.com/maplibre-gl@1.15.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@1.15.2/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
      #map {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      let loaded = false;
      const map = new maplibregl.Map({
        container: "map",
        center: [-73.99, 40.708],
        zoom: 11,
        minZoom: 12,
        maxBounds: [-74.262772, 40.487171, -73.745728, 40.907804],
        hash: true,
        style: "https://api.maptiler.com/maps/basic-v2-light/style.json?key=Q8UaCcftbOpyD2eC5SJS",
      });
      map.addControl(new maplibregl.NavigationControl());

      map.on("load", showLayer);

      function showLayer() {
        const sourceName = "es_mvt";
        const circleStyle = "layer_point";

        const circeRadius = { base: 1.75, stops: [ [12, 4], [22, 180], ], };

        const colorMappings = [
          "Noise - Residential",
          "#8dd3c7",
          "Illegal Parking",
          "#ffffb3",
          "Heat/hot Water",
          "#bebada",
          "Noise - Street/sidewalk",
          "#fb8072",
          "Blocked Driveway",
          "#80b1d3",
          "Noise - Vehicle",
          "#fdb462",
          "Street Condition",
          "#b3de69",
          "Unsanitary Condition",
          "#fccde5",
          "Street Light Condition",
          "#d9d9d9",
        ];

        map.addSource(sourceName, {
          type: "vector",
          tiles: [
            window.location.origin +
            "/tile/{z}/{x}/{y}",
          ],
          minzoom: 12,
          maxzoom: 24,
        });

        map.addLayer({
          id: "complaints",
          type: "circle",
          source: sourceName,
          "source-layer": "hits",
          paint: {
            "circle-radius": circeRadius,
            "circle-color": [
              "match",
              ["get", "Complaint Type"],
              "Noise - Residential",
              "#8dd3c7",
              "Illegal Parking",
              "#ffffb3",
              "Heat/hot Water",
              "#bebada",
              "Noise - Street/sidewalk",
              "#fb8072",
              "Blocked Driveway",
              "#80b1d3",
              "Noise - Vehicle",
              "#fdb462",
              "Street Condition",
              "#b3de69",
              "Unsanitary Condition",
              "#fccde5",
              "Street Light Condition",
              "#d9d9d9",
              ["rgba", 0, 0, 0, 0],
            ],
          },
        });


        map.on('click', 'complaints', function (e) {
            var coordinates = e.features[0].geometry.coordinates.slice();
            var description = e.features[0].properties["Complaint Type"];
            
            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }
            
            new maplibregl.Popup()
            .setLngLat(coordinates)
            .setHTML(description)
            .addTo(map);
        });
            
        // Change the cursor to a pointer when the mouse is over the places layer.
        map.on('mouseenter', 'complaints', function () {
            map.getCanvas().style.cursor = 'pointer';
        });
            
        // Change it back to a pointer when it leaves.
        map.on('mouseleave', 'complaints', function () {
            map.getCanvas().style.cursor = '';
        });
      }
    </script>
  </body>
</html>
